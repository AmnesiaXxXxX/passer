PRAGMA foreign_keys=OFF;
BEGIN TRANSACTION;
CREATE TABLE registrations (
    date TEXT PRIMARY KEY,           -- Дата события в формате YYYY-MM-DD
    visitors_count INTEGER DEFAULT 0,-- Количество зарегистрированных посетителей
    max_visitors INTEGER             -- Максимальное количество посетителей
);
INSERT INTO registrations VALUES('2025-04-19',6,178);
CREATE TABLE visitors (
    tg_id INTEGER,                   -- ID пользователя в Telegram
    to_datetime TEXT,                -- Дата записи (без времени) в формате YYYY-MM-DD
    hash_code TEXT,                  -- Хэш-код записи
    is_active INTEGER DEFAULT 1,     -- 1 - активен, 0 - неактивен
    FOREIGN KEY (to_datetime) REFERENCES registrations(date) -- Связь с таблицей событий
);
INSERT INTO visitors VALUES(6755197888,'2025-04-19','1ef14c2a597e9252ecde3d0c37cb1b3f2b6cfda923c90212e6eaa8a574edb717',1);
INSERT INTO visitors VALUES(7945254585,'2025-04-19','1ab4ac53c01e3ed6a72f9c38487c8764bf1d889d7d4fcd5d33367b9a5b747945',1);
INSERT INTO visitors VALUES(7259336826,'2025-04-19','e5c3a538fa2818655fbc48420da5efc870e570a6806d7cf3f102e8c81e942b5f',1);
INSERT INTO visitors VALUES(2114293108,'2025-04-19','9c9d3f335ad56fb642f46a527dae058e912e2f8ad1a650156b8d5074fb2527aa',1);
INSERT INTO visitors VALUES(1455727698,'2025-04-19','0b660434243f1e1dca37c55c991af91f1fced778b0e3101867b2f87a7afdd39a',1);
INSERT INTO visitors VALUES(5622105395,'2025-04-19','9ce24cb0adb76366bfc414253916970912d54a0ecbec418a1e0d6893a03e6abd',1);
CREATE TRIGGER update_visitors_count_delete
AFTER DELETE ON visitors
FOR EACH ROW
BEGIN
    UPDATE registrations
    SET visitors_count = (
        SELECT COUNT(*)
        FROM visitors
        WHERE to_datetime = OLD.to_datetime
          AND is_active = 1
    )
    WHERE date = OLD.to_datetime;
END;
CREATE TRIGGER update_visitors_count_update
AFTER UPDATE ON visitors
FOR EACH ROW
BEGIN
    -- Обновляем счетчик для старой даты (если дата изменилась)
    UPDATE registrations
    SET visitors_count = (
        SELECT COUNT(*)
        FROM visitors
        WHERE to_datetime = OLD.to_datetime
          AND is_active = 1
    )
    WHERE date = OLD.to_datetime;

    -- Обновляем счетчик для новой даты
    UPDATE registrations
    SET visitors_count = (
        SELECT COUNT(*)
        FROM visitors
        WHERE to_datetime = NEW.to_datetime
          AND is_active = 1
    )
    WHERE date = NEW.to_datetime;
END
;
CREATE TRIGGER update_visitors_count_insert
AFTER INSERT ON visitors
FOR EACH ROW
BEGIN
    UPDATE registrations
    SET visitors_count = (
        SELECT COUNT(*)
        FROM visitors
        WHERE to_datetime = NEW.to_datetime
          AND is_active = 1
    )
    WHERE date = NEW.to_datetime;
END;
COMMIT;
